<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏúÑÏπò ÌûàÏä§ÌÜ†Î¶¨ ÏßÄÎèÑ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .title {
            text-align: center;
            color: #333;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .url-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .url-input {
            padding: 12px 20px;
            border: 2px solid #4facfe;
            border-radius: 25px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            min-width: 300px;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }

        .url-input::placeholder {
            color: #999;
        }

        .load-button {
            background: linear-gradient(45deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .load-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .load-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .sheet-selector {
            padding: 12px 20px;
            border: 2px solid #4facfe;
            border-radius: 25px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .sheet-selector:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }

        .sheet-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sheet-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .sheet-checkbox:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        .sheet-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .arrow-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
        }

        .arrow-controls label {
            color: #333;
            font-weight: 600;
        }

        .arrow-checkbox {
            width: 18px;
            height: 18px;
        }

        .map-container {
            flex: 1;
            position: relative;
            margin: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #map {
            height: 80vh;
            min-height: 600px;
        }

        .info-popup {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .info-popup h4 {
            margin-bottom: 10px;
            color: #4facfe;
            font-weight: 600;
        }

        .info-popup .detail-row {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .info-popup .detail-row:last-child {
            margin-bottom: 0;
        }

        .info-popup .label {
            font-weight: 500;
            color: #ccc;
        }

        .info-popup .value {
            color: white;
            font-weight: 600;
        }

        .status {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 16px;
            font-weight: 500;
        }

        .sheet-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 250px;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .sheet-controls {
                justify-content: center;
            }
            
            .map-container {
                margin: 10px;
            }
            
            .sheet-legend {
                position: relative;
                margin-bottom: 10px;
            }
        }

        /* ÌôîÏÇ¥Ìëú Ïï†ÎãàÎ©îÏù¥ÏÖò */
        /* .arrow-marker {
            animation: arrowFlow 2s linear infinite;
        }

        @keyframes arrowFlow {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        } */
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">üìç ÏúÑÏπò ÌûàÏä§ÌÜ†Î¶¨ ÏßÄÎèÑ</h1>
        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" />
                <label for="csvFile" class="file-input-label">üìÑ ÌååÏùº ÏÑ†ÌÉù (CSV/XLSX)</label>
            </div>
            <div class="arrow-controls">
                <label for="showArrows">Î∞©Ìñ• ÌôîÏÇ¥Ìëú ÌëúÏãú:</label>
                <input type="checkbox" id="showArrows" class="arrow-checkbox" checked />
            </div>
            <div class="sheet-controls" id="sheetControls" style="display: none;">
                <span style="color: #333; font-weight: 600;">ÏãúÌä∏ ÏÑ†ÌÉù:</span>
            </div>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        <div class="sheet-legend" id="legend" style="display: none;">
            <div class="legend-title">ÏãúÌä∏Î≥Ñ ÏÉâÏÉÅ</div>
            <div id="legendItems"></div>
        </div>
    </div>

    <div class="status" id="status">CSV ÎòêÎäî XLSX ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</div>

    <script>
        let map;
        let allData = {};
        let mapLayers = {};
        let arrowLayers = {};
        let colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];
        let currentPopup = null;
        let showArrows = true;

        // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
        function initMap() {
            map = L.map('map').setView([37.5665, 126.9780], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Í±∞Î¶¨ Í≥ÑÏÇ∞ Ìï®Ïàò (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ÏãúÍ∞Ñ Ï∞®Ïù¥ Í≥ÑÏÇ∞ Ìï®Ïàò
        function calculateTimeDiff(time1, time2) {
            const diff = Math.abs(new Date(time2) - new Date(time1));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return hours > 0 ? `${hours}ÏãúÍ∞Ñ ${minutes}Î∂Ñ` : `${minutes}Î∂Ñ`;
        }

        // Îëê Ï†ê ÏÇ¨Ïù¥Ïùò Í∞ÅÎèÑ Í≥ÑÏÇ∞ (ÎùºÎîîÏïà)
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            
            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                     Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            return Math.atan2(y, x) * 180 / Math.PI - 90;
        }

        // Îëê Ï†ê ÏÇ¨Ïù¥Ïùò Ï§ëÍ∞Ñ ÏßÄÏ†êÎì§ Í≥ÑÏÇ∞
        function getIntermediatePoints(lat1, lng1, lat2, lng2, numPoints = 5) {
            const points = [];
            for (let i = 1; i <= numPoints; i++) {
                const ratio = i / (numPoints + 1);
                const lat = lat1 + (lat2 - lat1) * ratio;
                const lng = lng1 + (lng2 - lng1) * ratio;
                points.push([lat, lng]);
            }
            return points;
        }

        // // ÌôîÏÇ¥Ìëú ÎßàÏª§ ÏÉùÏÑ±
        // function createArrowMarker(lat, lng, bearing, color) {
        //     const arrowIcon = L.divIcon({
        //         html: `<div style="
        //             transform: rotate(${bearing}deg);
        //             color: ${color};
        //             font-size: 160px;
        //             font-weight: bold;
        //             text-shadow: 2px 2px 4px rgba(255,255,255,0.9), -2px -2px 4px rgba(0,0,0,0.3);
        //             text-align: center;
        //             line-height: 200px;
        //             filter: drop-shadow(0 0 8px rgba(0,0,0,0.5));
        //         ">‚ñ∂</div>`,
        //         className: 'arrow-marker',
        //         iconSize: [200, 200],
        //         iconAnchor: [100, 100]
        //     });

        //     const marker = L.marker([lat, lng], { icon: arrowIcon });
        //     return marker;
        // }

        function createArrowMarker(lat, lng, bearing, color) {
            const arrowIcon = L.divIcon({
                html: `<div style="
                    transform: rotate(${bearing}deg);
                    color: ${color};
                    font-size: 40px;                           // ÏõêÎ≥∏Í∞í
                    font-weight: 900;
                    text-shadow: 2px 2px 4px rgba(255,255,255,0.9), -2px -2px 4px rgba(0,0,0,0.3), 0 0 2px ${color};  // ÏõêÎ≥∏Í∞í
                    text-align: center;
                    line-height: 20px;                         // ÏõêÎ≥∏Í∞í
                ">></div>`,
                className: 'arrow-marker',
                iconSize: [20, 20],                            // ÏõêÎ≥∏Í∞í
                iconAnchor: [10, 10]                           // ÏõêÎ≥∏Í∞í
            });

            const marker = L.marker([lat, lng], { icon: arrowIcon });
            return marker;            
        }  

        // Í≤ΩÎ°úÏóê ÌôîÏÇ¥Ìëú Ï∂îÍ∞Ä
        function addArrowsToPath(locations, color, layerGroup) {
            const arrowMarkers = [];
            
            for (let i = 0; i < locations.length - 1; i++) {
                const start = locations[i];
                const end = locations[i + 1];
                
                // Îëê Ï†ê ÏÇ¨Ïù¥Ïùò Í±∞Î¶¨ ÌôïÏù∏ (ÎÑàÎ¨¥ Í∞ÄÍπåÏö∞Î©¥ ÌôîÏÇ¥Ìëú ÏÉùÎûµ)
                const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
                
                if (distance > 0.05) { // 50m Ïù¥ÏÉÅÏùº ÎïåÎßå ÌôîÏÇ¥Ìëú ÌëúÏãú
                    const bearing = calculateBearing(start.lat, start.lng, end.lat, end.lng);
                    
                    // Í≤ΩÎ°úÍ∞Ä Ï∂©Î∂ÑÌûà Í∏∏Î©¥ Ï§ëÍ∞ÑÏóê Ïó¨Îü¨ ÌôîÏÇ¥Ìëú ÌëúÏãú
                    if (distance > 0.5) { // 500m Ïù¥ÏÉÅ
                        const numArrows = Math.min(Math.floor(distance * 2), 8); // ÏµúÎåÄ 8Í∞ú
                        const intermediatePoints = getIntermediatePoints(
                            start.lat, start.lng, end.lat, end.lng, numArrows
                        );
                        
                        intermediatePoints.forEach(point => {
                            const arrowMarker = createArrowMarker(point[0], point[1], bearing, color);
                            arrowMarkers.push(arrowMarker);
                            layerGroup.addLayer(arrowMarker);
                        });
                    } else {
                        // ÏßßÏùÄ Í≤ΩÎ°úÎäî Ï§ëÏïôÏóê ÌïòÎÇòÎßå
                        const midLat = (start.lat + end.lat) / 2;
                        const midLng = (start.lng + end.lng) / 2;
                        const arrowMarker = createArrowMarker(midLat, midLng, bearing, color);
                        arrowMarkers.push(arrowMarker);
                        layerGroup.addLayer(arrowMarker);
                    }
                }
            }
            
            return arrowMarkers;
        }

        // ÌåùÏóÖ Ï†úÍ±∞ Ìï®Ïàò
        function clearPopup() {
            if (currentPopup) {
                map.closePopup(currentPopup);
                currentPopup = null;
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Î∞è ÏßÄÎèÑÏóê ÌëúÏãú
        function processAndDisplayData(sheetName, data, color) {
            console.log(`processAndDisplayData Ìò∏Ï∂ú: ${sheetName}, Îç∞Ïù¥ÌÑ∞ Í∏∏Ïù¥: ${data.length}`);
            
            if (!data || data.length === 0) {
                console.log('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùå');
                return;
            }

            // Ïª¨Îüº Ïù∏Îç±Ïä§ Ï∞æÍ∏∞
            const headers = data[0];
            console.log('Ìó§Îçî:', headers);
            
            const tsIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('ts_local'));
            const latIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('lat'));
            const lngIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('lng'));

            console.log(`Ïª¨Îüº Ïù∏Îç±Ïä§ - ts_local: ${tsIndex}, lat: ${latIndex}, lng: ${lngIndex}`);

            if (tsIndex === -1 || latIndex === -1 || lngIndex === -1) {
                console.error(`ÌïÑÏöîÌïú Ïª¨ÎüºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${sheetName}`);
                console.log('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ìó§ÎçîÎì§:', headers);
                return;
            }

            // Îç∞Ïù¥ÌÑ∞ ÌååÏã± Î∞è Ï†ïÎ†¨
            const locations = data.slice(1)
                .map((row, index) => {
                    const location = {
                        timestamp: row[tsIndex],
                        lat: parseFloat(row[latIndex]),
                        lng: parseFloat(row[lngIndex]),
                        rawData: row,
                        headers: headers,
                        rowIndex: index + 2
                    };
                    return location;
                })
                .filter(loc => {
                    const isValid = !isNaN(loc.lat) && !isNaN(loc.lng) && loc.timestamp;
                    if (!isValid) {
                        console.log('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏúÑÏπò Îç∞Ïù¥ÌÑ∞:', loc);
                    }
                    return isValid;
                })
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            console.log(`Ïú†Ìö®Ìïú ÏúÑÏπò Îç∞Ïù¥ÌÑ∞ Ïàò: ${locations.length}`);
            
            if (locations.length === 0) {
                console.log('Ïú†Ìö®Ìïú ÏúÑÏπò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùå');
                return;
            }

            console.log('Ï≤´ Î≤àÏß∏ ÏúÑÏπò:', locations[0]);
            console.log('ÎßàÏßÄÎßâ ÏúÑÏπò:', locations[locations.length - 1]);

            // Î†àÏù¥Ïñ¥ Í∑∏Î£π ÏÉùÏÑ±
            const layerGroup = L.layerGroup();
            const arrowLayerGroup = L.layerGroup();
            mapLayers[sheetName] = layerGroup;
            arrowLayers[sheetName] = arrowLayerGroup;

            // Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞
            if (locations.length > 1) {
                const pathCoords = locations.map(loc => [loc.lat, loc.lng]);
                console.log('Í≤ΩÎ°ú Ï¢åÌëú Ïàò:', pathCoords.length);
                
                const polyline = L.polyline(pathCoords, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                });

                // Í≤ΩÎ°ú ÏÑ∏Í∑∏Î®ºÌä∏Î≥Ñ Ìò∏Î≤Ñ Ïù¥Î≤§Ìä∏
                for (let i = 0; i < locations.length - 1; i++) {
                    const segmentCoords = [
                        [locations[i].lat, locations[i].lng],
                        [locations[i + 1].lat, locations[i + 1].lng]
                    ];
                    
                    const segment = L.polyline(segmentCoords, {
                        color: color,
                        weight: 6,
                        opacity: 0
                    });

                    const distance = calculateDistance(
                        locations[i].lat, locations[i].lng,
                        locations[i + 1].lat, locations[i + 1].lng
                    );
                    const timeDiff = calculateTimeDiff(locations[i].timestamp, locations[i + 1].timestamp);

                    segment.on('mouseover', function(e) {
                        clearPopup();
                        const popup = L.popup({
                            closeButton: false,
                            className: 'info-popup'
                        })
                        .setLatLng(e.latlng)
                        .setContent(`
                            <div class="info-popup">
                                <h4>üõ£Ô∏è Í≤ΩÎ°ú Ï†ïÎ≥¥</h4>
                                <div class="detail-row">
                                    <span class="label">Í±∞Î¶¨:</span>
                                    <span class="value">${distance.toFixed(2)}km</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">ÏãúÍ∞ÑÏ∞®:</span>
                                    <span class="value">${timeDiff}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">ÏãúÌä∏:</span>
                                    <span class="value">${sheetName}</span>
                                </div>
                            </div>
                        `)
                        .openOn(map);
                        currentPopup = popup;
                    });

                    segment.on('mouseout', clearPopup);
                    layerGroup.addLayer(segment);
                }

                layerGroup.addLayer(polyline);

                // ÌôîÏÇ¥Ìëú Ï∂îÍ∞Ä
                if (showArrows) {
                    addArrowsToPath(locations, color, arrowLayerGroup);
                }
            }

            // ÌïÄ Ï∂îÍ∞Ä
            locations.forEach((location, index) => {
                const marker = L.circleMarker([location.lat, location.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.on('mouseover', function(e) {
                    clearPopup();
                    const detailsHtml = location.headers.map((header, idx) => {
                        if (location.rawData[idx] && location.rawData[idx].toString().trim()) {
                            return `
                                <div class="detail-row">
                                    <span class="label">${header}:</span>
                                    <span class="value">${location.rawData[idx]}</span>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');

                    const popup = L.popup({
                        closeButton: false,
                        className: 'info-popup'
                    })
                    .setLatLng(e.latlng)
                    .setContent(`
                        <div class="info-popup">
                            <h4>üìç ÏúÑÏπò Ï†ïÎ≥¥ (Row ${location.rowIndex})</h4>
                            ${detailsHtml}
                            <div class="detail-row">
                                <span class="label">ÏãúÌä∏:</span>
                                <span class="value">${sheetName}</span>
                            </div>
                        </div>
                    `)
                    .openOn(map);
                    currentPopup = popup;
                });

                marker.on('mouseout', clearPopup);
                layerGroup.addLayer(marker);
            });

            layerGroup.addTo(map);
            if (showArrows) {
                arrowLayerGroup.addTo(map);
            }
            
            console.log(`${sheetName} Î†àÏù¥Ïñ¥Í∞Ä ÏßÄÎèÑÏóê Ï∂îÍ∞ÄÎê®`);

            // ÏßÄÎèÑ Î≤îÏúÑ Ï°∞Ï†ï
            if (locations.length > 0) {
                const group = new L.featureGroup(locations.map(loc => 
                    L.marker([loc.lat, loc.lng])
                ));
                map.fitBounds(group.getBounds().pad(0.1));
                console.log('ÏßÄÎèÑ Î≤îÏúÑ Ï°∞Ï†ï ÏôÑÎ£å');
            }
        }

        // ÌôîÏÇ¥Ìëú ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        function toggleArrows() {
            showArrows = document.getElementById('showArrows').checked;
            
            Object.keys(arrowLayers).forEach(sheetName => {
                if (showArrows) {
                    arrowLayers[sheetName].addTo(map);
                } else {
                    map.removeLayer(arrowLayers[sheetName]);
                }
            });
        }

        // ÏãúÌä∏ Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉùÏÑ±
        function createSheetControls() {
            const controlsDiv = document.getElementById('sheetControls');
            const legendDiv = document.getElementById('legendItems');
            
            controlsDiv.innerHTML = '<span style="color: #333; font-weight: 600;">ÏãúÌä∏ ÏÑ†ÌÉù:</span>';
            legendDiv.innerHTML = '';

            Object.keys(allData).forEach((sheetName, index) => {
                const color = colors[index % colors.length];
                
                // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉùÏÑ±
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'sheet-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `sheet_${index}`;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        processAndDisplayData(sheetName, allData[sheetName], color);
                    } else {
                        if (mapLayers[sheetName]) {
                            map.removeLayer(mapLayers[sheetName]);
                        }
                        if (arrowLayers[sheetName]) {
                            map.removeLayer(arrowLayers[sheetName]);
                        }
                    }
                    clearPopup();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `sheet_${index}`;
                label.textContent = sheetName;
                label.style.color = color;
                label.style.fontWeight = '600';
                
                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);
                controlsDiv.appendChild(checkboxWrapper);

                // Î≤îÎ°Ä ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span>${sheetName}</span>
                `;
                legendDiv.appendChild(legendItem);
            });

            controlsDiv.style.display = 'flex';
            document.getElementById('legend').style.display = 'block';
        }

        // CSV ÌååÏùº Ï≤òÎ¶¨
        function handleFileSelect(event) {
            console.log('ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î∞úÏÉù');
            const file = event.target.files[0];
            if (!file) {
                console.log('ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùå');
                return;
            }

            console.log('ÏÑ†ÌÉùÎêú ÌååÏùº:', file.name, file.size, 'bytes');
            document.getElementById('status').textContent = 'ÌååÏùº Ï≤òÎ¶¨ Ï§ë...';
            
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('ÌååÏùº ÌååÏã± ÏôÑÎ£å. Îç∞Ïù¥ÌÑ∞ Ìñâ Ïàò:', results.data.length);
                    console.log('Ï≤´ Î≤àÏß∏ Ìñâ:', results.data[0]);
                    
                    // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ Î†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî
                    allData = {};
                    Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
                    Object.values(arrowLayers).forEach(layer => map.removeLayer(layer));
                    mapLayers = {};
                    arrowLayers = {};
                    
                    // ÏãúÌä∏ Íµ¨Î∂Ñ Î°úÏßÅ Í∞úÏÑ†
                    const data = results.data;
                    console.log('Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ìñâ Ïàò:', data.length);
                    
                    // Ìó§Îçî Ìñâ Ï∞æÍ∏∞ Ìï®Ïàò
                    function isHeaderRow(row) {
                        if (!row || row.length === 0) return false;
                        const rowStr = row.map(cell => cell ? cell.toString().toLowerCase() : '').join('');
                        return rowStr.includes('ts_local') && rowStr.includes('lat') && rowStr.includes('lng');
                    }
                    
                    // Îπà Ìñâ ÌôïÏù∏ Ìï®Ïàò
                    function isEmptyRow(row) {
                        return !row || row.every(cell => !cell || cell.toString().trim() === '');
                    }
                    
                    // Ìó§Îçî ÌñâÎì§ Ï∞æÍ∏∞
                    const headerIndices = [];
                    for (let i = 0; i < data.length; i++) {
                        if (isHeaderRow(data[i])) {
                            headerIndices.push(i);
                            console.log(`Ìó§Îçî Ìñâ Î∞úÍ≤¨: ${i}Î≤àÏß∏ Ìñâ`, data[i]);
                        }
                    }
                    
                    console.log('Î∞úÍ≤¨Îêú Ìó§Îçî Ìñâ Ïù∏Îç±Ïä§Îì§:', headerIndices);
                    
                    if (headerIndices.length === 0) {
                        console.log('Ìó§ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ ÌñâÏùÑ Ìó§ÎçîÎ°ú Í∞ÄÏ†ïÌï©ÎãàÎã§.');
                        allData['Sheet1'] = data;
                    } else if (headerIndices.length === 1) {
                        // Îã®Ïùº ÏãúÌä∏
                        console.log('Îã®Ïùº ÏãúÌä∏Î°ú Ï≤òÎ¶¨');
                        allData['Sheet1'] = data;
                    } else {
                        // Îã§Ï§ë ÏãúÌä∏ Ï≤òÎ¶¨
                        console.log('Îã§Ï§ë ÏãúÌä∏Î°ú Ï≤òÎ¶¨');
                        
                        for (let i = 0; i < headerIndices.length; i++) {
                            const startIndex = headerIndices[i];
                            let endIndex;
                            
                            if (i < headerIndices.length - 1) {
                                // Îã§Ïùå Ìó§Îçî ÏßÅÏ†ÑÍπåÏßÄ
                                endIndex = headerIndices[i + 1];
                            } else {
                                // ÎßàÏßÄÎßâ ÏãúÌä∏Îäî ÌååÏùº ÎÅùÍπåÏßÄ
                                endIndex = data.length;
                            }
                            
                            // ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
                            let sheetData = data.slice(startIndex, endIndex);
                            
                            // ÎÅùÏóêÏÑú Îπà ÌñâÎì§ Ï†úÍ±∞
                            while (sheetData.length > 1 && isEmptyRow(sheetData[sheetData.length - 1])) {
                                sheetData.pop();
                            }
                            
                            if (sheetData.length > 1) { // Ìó§Îçî + ÏµúÏÜå 1Í∞ú Îç∞Ïù¥ÌÑ∞ Ìñâ
                                const sheetName = `Sheet${i + 1}`;
                                allData[sheetName] = sheetData;
                                console.log(`${sheetName} ÏÉùÏÑ±: ${sheetData.length}Ìñâ`);
                            }
                        }
                    }
                    
                    // ÎåÄÏïà: Îπà ÌñâÏúºÎ°ú Íµ¨Î∂ÑÌïòÎäî Î∞©ÏãùÎèÑ ÏãúÎèÑ
                    if (Object.keys(allData).length <= 1 && headerIndices.length === 0) {
                        console.log('Ìó§Îçî Í∏∞Î∞ò Î∂ÑÌï† Ïã§Ìå®. Îπà Ìñâ Í∏∞Î∞òÏúºÎ°ú Ïû¨ÏãúÎèÑ');
                        allData = {};
                        
                        let currentSheet = [];
                        let sheetIndex = 1;
                        let hasFoundValidSheet = false;
                        
                        for (let i = 0; i < data.length; i++) {
                            const row = data[i];
                            
                            if (isEmptyRow(row)) {
                                if (currentSheet.length > 0) {
                                    // ÌòÑÏû¨ ÏãúÌä∏Ïóê Ìó§ÎçîÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                                    const hasHeader = currentSheet.some(r => isHeaderRow(r));
                                    if (hasHeader || currentSheet.length > 3) { // Ìó§ÎçîÍ∞Ä ÏûàÍ±∞ÎÇò Ï∂©Î∂ÑÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥
                                        const sheetName = `Sheet${sheetIndex}`;
                                        allData[sheetName] = [...currentSheet];
                                        console.log(`Îπà Ìñâ Í∏∞Î∞ò ${sheetName} ÏÉùÏÑ±: ${currentSheet.length}Ìñâ`);
                                        hasFoundValidSheet = true;
                                        sheetIndex++;
                                    }
                                    currentSheet = [];
                                }
                            } else {
                                currentSheet.push(row);
                            }
                        }
                        
                        // ÎßàÏßÄÎßâ ÏãúÌä∏ Ï∂îÍ∞Ä
                        if (currentSheet.length > 0) {
                            const hasHeader = currentSheet.some(r => isHeaderRow(r));
                            if (hasHeader || currentSheet.length > 3) {
                                const sheetName = `Sheet${sheetIndex}`;
                                allData[sheetName] = [...currentSheet];
                                console.log(`Îπà Ìñâ Í∏∞Î∞ò ÎßàÏßÄÎßâ ${sheetName} ÏÉùÏÑ±: ${currentSheet.length}Ìñâ`);
                                hasFoundValidSheet = true;
                            }
                        }
                        
                        // Í∑∏ÎûòÎèÑ Ïã§Ìå®ÌïòÎ©¥ Ï†ÑÏ≤¥Î•º ÌïòÎÇòÏùò ÏãúÌä∏Î°ú
                        if (!hasFoundValidSheet) {
                            console.log('Î™®Îì† Î∂ÑÌï† Î∞©Ïãù Ïã§Ìå®. Ï†ÑÏ≤¥Î•º ÌïòÎÇòÏùò ÏãúÌä∏Î°ú Ï≤òÎ¶¨');
                            allData['Sheet1'] = data;
                        }
                    }

                    console.log('Ï≤òÎ¶¨Îêú ÏãúÌä∏ Ïàò:', Object.keys(allData).length);
                    console.log('ÏãúÌä∏ Ïù¥Î¶ÑÎì§:', Object.keys(allData));

                    // ÏãúÌä∏ Ïª®Ìä∏Î°§ ÏÉùÏÑ±
                    createSheetControls();
                    
                    // Î™®Îì† ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                    Object.keys(allData).forEach((sheetName, index) => {
                        const color = colors[index % colors.length];
                        console.log(`ÏãúÌä∏ ${sheetName} Ï≤òÎ¶¨ ÏãúÏûë, ÏÉâÏÉÅ: ${color}`);
                        processAndDisplayData(sheetName, allData[sheetName], color);
                    });

                    document.getElementById('status').textContent = 
                        `${Object.keys(allData).length}Í∞ú ÏãúÌä∏ Î°úÎìú ÏôÑÎ£å`;
                },
                error: function(error) {
                    console.error('CSV ÌååÏã± Ïò§Î•ò:', error);
                    document.getElementById('status').textContent = 'ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                }
            });
        }

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            document.getElementById('csvFile').addEventListener('change', handleFileSelect);
            document.getElementById('showArrows').addEventListener('change', toggleArrows);
            
            // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïãú ÌåùÏóÖ Ï†úÍ±∞
            map.on('click', clearPopup);
        });
    </script>
</body>
</html>