<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ íˆìŠ¤í† ë¦¬ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .title {
            text-align: center;
            color: #333;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .url-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .url-input {
            padding: 12px 20px;
            border: 2px solid #4facfe;
            border-radius: 25px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            min-width: 300px;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }

        .url-input::placeholder {
            color: #999;
        }

        .load-button {
            background: linear-gradient(45deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .load-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .load-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .sheet-selector {
            padding: 12px 20px;
            border: 2px solid #4facfe;
            border-radius: 25px;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .sheet-selector:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }

        .sheet-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sheet-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .sheet-checkbox:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        .sheet-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .arrow-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
        }

        .arrow-controls label {
            color: #333;
            font-weight: 600;
        }

        .arrow-checkbox {
            width: 18px;
            height: 18px;
        }

        .map-container {
            flex: 1;
            position: relative;
            margin: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #map {
            height: 80vh;
            min-height: 600px;
        }

        .info-popup {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .info-popup h4 {
            margin-bottom: 10px;
            color: #4facfe;
            font-weight: 600;
        }

        .info-popup .detail-row {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .info-popup .detail-row:last-child {
            margin-bottom: 0;
        }

        .info-popup .label {
            font-weight: 500;
            color: #ccc;
        }

        .info-popup .value {
            color: white;
            font-weight: 600;
        }

        .status {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 16px;
            font-weight: 500;
        }

        .sheet-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 250px;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .sheet-controls {
                justify-content: center;
            }
            
            .map-container {
                margin: 10px;
            }
            
            .sheet-legend {
                position: relative;
                margin-bottom: 10px;
            }
        }

        /* í™”ì‚´í‘œ ì• ë‹ˆë©”ì´ì…˜ */
        /* .arrow-marker {
            animation: arrowFlow 2s linear infinite;
        }

        @keyframes arrowFlow {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        } */
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ“ ìœ„ì¹˜ íˆìŠ¤í† ë¦¬ ì§€ë„</h1>
        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" />
                <label for="csvFile" class="file-input-label">ğŸ“„ íŒŒì¼ ì„ íƒ (CSV/XLSX)</label>
            </div>
            <div class="arrow-controls">
                <label for="showArrows">ë°©í–¥ í™”ì‚´í‘œ í‘œì‹œ:</label>
                <input type="checkbox" id="showArrows" class="arrow-checkbox" checked />
            </div>
            <div class="sheet-controls" id="sheetControls" style="display: none;">
                <span style="color: #333; font-weight: 600;">ì‹œíŠ¸ ì„ íƒ:</span>
            </div>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        <div class="sheet-legend" id="legend" style="display: none;">
            <div class="legend-title">ì‹œíŠ¸ë³„ ìƒ‰ìƒ</div>
            <div id="legendItems"></div>
        </div>
    </div>

    <div class="status" id="status">CSV ë˜ëŠ” XLSX íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>

    <script>
        let map;
        let allData = {};
        let mapLayers = {};
        let arrowLayers = {};
        let colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];
        let currentPopup = null;
        let showArrows = true;

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            map = L.map('map').setView([37.5665, 126.9780], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ì‹œê°„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
        function calculateTimeDiff(time1, time2) {
            const diff = Math.abs(new Date(time2) - new Date(time1));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return hours > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : `${minutes}ë¶„`;
        }

        // ë‘ ì  ì‚¬ì´ì˜ ê°ë„ ê³„ì‚° (ë¼ë””ì•ˆ)
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            
            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                     Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            return Math.atan2(y, x) * 180 / Math.PI - 90;
        }

        // ë‘ ì  ì‚¬ì´ì˜ ì¤‘ê°„ ì§€ì ë“¤ ê³„ì‚°
        function getIntermediatePoints(lat1, lng1, lat2, lng2, numPoints = 5) {
            const points = [];
            for (let i = 1; i <= numPoints; i++) {
                const ratio = i / (numPoints + 1);
                const lat = lat1 + (lat2 - lat1) * ratio;
                const lng = lng1 + (lng2 - lng1) * ratio;
                points.push([lat, lng]);
            }
            return points;
        }

        // // í™”ì‚´í‘œ ë§ˆì»¤ ìƒì„±
        // function createArrowMarker(lat, lng, bearing, color) {
        //     const arrowIcon = L.divIcon({
        //         html: `<div style="
        //             transform: rotate(${bearing}deg);
        //             color: ${color};
        //             font-size: 160px;
        //             font-weight: bold;
        //             text-shadow: 2px 2px 4px rgba(255,255,255,0.9), -2px -2px 4px rgba(0,0,0,0.3);
        //             text-align: center;
        //             line-height: 200px;
        //             filter: drop-shadow(0 0 8px rgba(0,0,0,0.5));
        //         ">â–¶</div>`,
        //         className: 'arrow-marker',
        //         iconSize: [200, 200],
        //         iconAnchor: [100, 100]
        //     });

        //     const marker = L.marker([lat, lng], { icon: arrowIcon });
        //     return marker;
        // }

        function createArrowMarker(lat, lng, bearing, color) {
            const arrowIcon = L.divIcon({
                html: `<div style="
                    transform: rotate(${bearing}deg);
                    color: ${color};
                    font-size: 40px;                           // ì›ë³¸ê°’
                    font-weight: 900;
                    text-shadow: 2px 2px 4px rgba(255,255,255,0.9), -2px -2px 4px rgba(0,0,0,0.3), 0 0 2px ${color};  // ì›ë³¸ê°’
                    text-align: center;
                    line-height: 20px;                         // ì›ë³¸ê°’
                ">></div>`,
                className: 'arrow-marker',
                iconSize: [20, 20],                            // ì›ë³¸ê°’
                iconAnchor: [10, 10]                           // ì›ë³¸ê°’
            });

            const marker = L.marker([lat, lng], { icon: arrowIcon });
            return marker;            
        }  

        // ê²½ë¡œì— í™”ì‚´í‘œ ì¶”ê°€
        function addArrowsToPath(locations, color, layerGroup) {
            const arrowMarkers = [];
            
            for (let i = 0; i < locations.length - 1; i++) {
                const start = locations[i];
                const end = locations[i + 1];
                
                // ë‘ ì  ì‚¬ì´ì˜ ê±°ë¦¬ í™•ì¸ (ë„ˆë¬´ ê°€ê¹Œìš°ë©´ í™”ì‚´í‘œ ìƒëµ)
                const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
                
                if (distance > 0.05) { // 50m ì´ìƒì¼ ë•Œë§Œ í™”ì‚´í‘œ í‘œì‹œ
                    const bearing = calculateBearing(start.lat, start.lng, end.lat, end.lng);
                    
                    // ê²½ë¡œê°€ ì¶©ë¶„íˆ ê¸¸ë©´ ì¤‘ê°„ì— ì—¬ëŸ¬ í™”ì‚´í‘œ í‘œì‹œ
                    if (distance > 0.5) { // 500m ì´ìƒ
                        const numArrows = Math.min(Math.floor(distance * 2), 8); // ìµœëŒ€ 8ê°œ
                        const intermediatePoints = getIntermediatePoints(
                            start.lat, start.lng, end.lat, end.lng, numArrows
                        );
                        
                        intermediatePoints.forEach(point => {
                            const arrowMarker = createArrowMarker(point[0], point[1], bearing, color);
                            arrowMarkers.push(arrowMarker);
                            layerGroup.addLayer(arrowMarker);
                        });
                    } else {
                        // ì§§ì€ ê²½ë¡œëŠ” ì¤‘ì•™ì— í•˜ë‚˜ë§Œ
                        const midLat = (start.lat + end.lat) / 2;
                        const midLng = (start.lng + end.lng) / 2;
                        const arrowMarker = createArrowMarker(midLat, midLng, bearing, color);
                        arrowMarkers.push(arrowMarker);
                        layerGroup.addLayer(arrowMarker);
                    }
                }
            }
            
            return arrowMarkers;
        }

        // íŒì—… ì œê±° í•¨ìˆ˜
        function clearPopup() {
            if (currentPopup) {
                map.closePopup(currentPopup);
                currentPopup = null;
            }
        }

        // ë°ì´í„° ì²˜ë¦¬ ë° ì§€ë„ì— í‘œì‹œ
        function processAndDisplayData(sheetName, data, color) {
            console.log(`processAndDisplayData í˜¸ì¶œ: ${sheetName}, ë°ì´í„° ê¸¸ì´: ${data.length}`);
            
            if (!data || data.length === 0) {
                console.log('ë°ì´í„°ê°€ ì—†ìŒ');
                return;
            }

            // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
            const headers = data[0];
            console.log('í—¤ë”:', headers);
            
            const tsIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('ts_local'));
            const latIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('lat'));
            const lngIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('lng'));

            console.log(`ì»¬ëŸ¼ ì¸ë±ìŠ¤ - ts_local: ${tsIndex}, lat: ${latIndex}, lng: ${lngIndex}`);

            if (tsIndex === -1 || latIndex === -1 || lngIndex === -1) {
                console.error(`í•„ìš”í•œ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${sheetName}`);
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ í—¤ë”ë“¤:', headers);
                return;
            }

            // ë°ì´í„° íŒŒì‹± ë° ì •ë ¬
            const locations = data.slice(1)
                .map((row, index) => {
                    const location = {
                        timestamp: row[tsIndex],
                        lat: parseFloat(row[latIndex]),
                        lng: parseFloat(row[lngIndex]),
                        rawData: row,
                        headers: headers,
                        rowIndex: index + 2
                    };
                    return location;
                })
                .filter(loc => {
                    const isValid = !isNaN(loc.lat) && !isNaN(loc.lng) && loc.timestamp;
                    if (!isValid) {
                        console.log('ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ ë°ì´í„°:', loc);
                    }
                    return isValid;
                })
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            console.log(`ìœ íš¨í•œ ìœ„ì¹˜ ë°ì´í„° ìˆ˜: ${locations.length}`);
            
            if (locations.length === 0) {
                console.log('ìœ íš¨í•œ ìœ„ì¹˜ ë°ì´í„°ê°€ ì—†ìŒ');
                return;
            }

            console.log('ì²« ë²ˆì§¸ ìœ„ì¹˜:', locations[0]);
            console.log('ë§ˆì§€ë§‰ ìœ„ì¹˜:', locations[locations.length - 1]);

            // ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±
            const layerGroup = L.layerGroup();
            const arrowLayerGroup = L.layerGroup();
            mapLayers[sheetName] = layerGroup;
            arrowLayers[sheetName] = arrowLayerGroup;

            // ê²½ë¡œ ê·¸ë¦¬ê¸°
            if (locations.length > 1) {
                const pathCoords = locations.map(loc => [loc.lat, loc.lng]);
                console.log('ê²½ë¡œ ì¢Œí‘œ ìˆ˜:', pathCoords.length);
                
                const polyline = L.polyline(pathCoords, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                });

                // ê²½ë¡œ ì„¸ê·¸ë¨¼íŠ¸ë³„ í˜¸ë²„ ì´ë²¤íŠ¸
                for (let i = 0; i < locations.length - 1; i++) {
                    const segmentCoords = [
                        [locations[i].lat, locations[i].lng],
                        [locations[i + 1].lat, locations[i + 1].lng]
                    ];
                    
                    const segment = L.polyline(segmentCoords, {
                        color: color,
                        weight: 6,
                        opacity: 0
                    });

                    const distance = calculateDistance(
                        locations[i].lat, locations[i].lng,
                        locations[i + 1].lat, locations[i + 1].lng
                    );
                    const timeDiff = calculateTimeDiff(locations[i].timestamp, locations[i + 1].timestamp);

                    segment.on('mouseover', function(e) {
                        clearPopup();
                        const popup = L.popup({
                            closeButton: false,
                            className: 'info-popup'
                        })
                        .setLatLng(e.latlng)
                        .setContent(`
                            <div class="info-popup">
                                <h4>ğŸ›£ï¸ ê²½ë¡œ ì •ë³´</h4>
                                <div class="detail-row">
                                    <span class="label">ê±°ë¦¬:</span>
                                    <span class="value">${distance.toFixed(2)}km</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">ì‹œê°„ì°¨:</span>
                                    <span class="value">${timeDiff}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">ì‹œíŠ¸:</span>
                                    <span class="value">${sheetName}</span>
                                </div>
                            </div>
                        `)
                        .openOn(map);
                        currentPopup = popup;
                    });

                    segment.on('mouseout', clearPopup);
                    layerGroup.addLayer(segment);
                }

                layerGroup.addLayer(polyline);

                // í™”ì‚´í‘œ ì¶”ê°€
                if (showArrows) {
                    addArrowsToPath(locations, color, arrowLayerGroup);
                }
            }

            // í•€ ì¶”ê°€
            locations.forEach((location, index) => {
                const marker = L.circleMarker([location.lat, location.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.on('mouseover', function(e) {
                    clearPopup();
                    const detailsHtml = location.headers.map((header, idx) => {
                        if (location.rawData[idx] && location.rawData[idx].toString().trim()) {
                            return `
                                <div class="detail-row">
                                    <span class="label">${header}:</span>
                                    <span class="value">${location.rawData[idx]}</span>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');

                    const popup = L.popup({
                        closeButton: false,
                        className: 'info-popup'
                    })
                    .setLatLng(e.latlng)
                    .setContent(`
                        <div class="info-popup">
                            <h4>ğŸ“ ìœ„ì¹˜ ì •ë³´ (Row ${location.rowIndex})</h4>
                            ${detailsHtml}
                            <div class="detail-row">
                                <span class="label">ì‹œíŠ¸:</span>
                                <span class="value">${sheetName}</span>
                            </div>
                        </div>
                    `)
                    .openOn(map);
                    currentPopup = popup;
                });

                marker.on('mouseout', clearPopup);
                layerGroup.addLayer(marker);
            });

            layerGroup.addTo(map);
            if (showArrows) {
                arrowLayerGroup.addTo(map);
            }
            
            console.log(`${sheetName} ë ˆì´ì–´ê°€ ì§€ë„ì— ì¶”ê°€ë¨`);

            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (locations.length > 0) {
                const group = new L.featureGroup(locations.map(loc => 
                    L.marker([loc.lat, loc.lng])
                ));
                map.fitBounds(group.getBounds().pad(0.1));
                console.log('ì§€ë„ ë²”ìœ„ ì¡°ì • ì™„ë£Œ');
            }
        }

        // í™”ì‚´í‘œ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
        function toggleArrows() {
            showArrows = document.getElementById('showArrows').checked;
            
            Object.keys(arrowLayers).forEach(sheetName => {
                if (showArrows) {
                    arrowLayers[sheetName].addTo(map);
                } else {
                    map.removeLayer(arrowLayers[sheetName]);
                }
            });
        }

        // ì‹œíŠ¸ ì²´í¬ë°•ìŠ¤ ìƒì„±
        function createSheetControls() {
            const controlsDiv = document.getElementById('sheetControls');
            const legendDiv = document.getElementById('legendItems');
            
            controlsDiv.innerHTML = '<span style="color: #333; font-weight: 600;">ì‹œíŠ¸ ì„ íƒ:</span>';
            legendDiv.innerHTML = '';

            Object.keys(allData).forEach((sheetName, index) => {
                const color = colors[index % colors.length];
                
                // ì²´í¬ë°•ìŠ¤ ìƒì„±
                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'sheet-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `sheet_${index}`;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        processAndDisplayData(sheetName, allData[sheetName], color);
                    } else {
                        if (mapLayers[sheetName]) {
                            map.removeLayer(mapLayers[sheetName]);
                        }
                        if (arrowLayers[sheetName]) {
                            map.removeLayer(arrowLayers[sheetName]);
                        }
                    }
                    clearPopup();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `sheet_${index}`;
                label.textContent = sheetName;
                label.style.color = color;
                label.style.fontWeight = '600';
                
                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);
                controlsDiv.appendChild(checkboxWrapper);

                // ë²”ë¡€ ì•„ì´í…œ ìƒì„±
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span>${sheetName}</span>
                `;
                legendDiv.appendChild(legendItem);
            });

            controlsDiv.style.display = 'flex';
            document.getElementById('legend').style.display = 'block';
        }

        // CSV íŒŒì¼ ì²˜ë¦¬
        function handleFileSelect(event) {
            console.log('íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë°œìƒ');
            const file = event.target.files[0];
            if (!file) {
                console.log('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ');
                return;
            }

            console.log('ì„ íƒëœ íŒŒì¼:', file.name, file.size, 'bytes');
            document.getElementById('status').textContent = 'íŒŒì¼ ì²˜ë¦¬ ì¤‘...';
            
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('íŒŒì¼ íŒŒì‹± ì™„ë£Œ. ë°ì´í„° í–‰ ìˆ˜:', results.data.length);
                    console.log('ì²« ë²ˆì§¸ í–‰:', results.data[0]);
                    
                    // ê¸°ì¡´ ë°ì´í„°ì™€ ë ˆì´ì–´ ì´ˆê¸°í™”
                    allData = {};
                    Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
                    Object.values(arrowLayers).forEach(layer => map.removeLayer(layer));
                    mapLayers = {};
                    arrowLayers = {};
                    
                    // ì‹œíŠ¸ êµ¬ë¶„ ë¡œì§ ê°œì„ 
                    const data = results.data;
                    console.log('ì „ì²´ ë°ì´í„° í–‰ ìˆ˜:', data.length);
                    
                    // í—¤ë” í–‰ ì°¾ê¸° í•¨ìˆ˜
                    function isHeaderRow(row) {
                        if (!row || row.length === 0) return false;
                        const rowStr = row.map(cell => cell ? cell.toString().toLowerCase() : '').join('');
                        return rowStr.includes('ts_local') && rowStr.includes('lat') && rowStr.includes('lng');
                    }
                    
                    // ë¹ˆ í–‰ í™•ì¸ í•¨ìˆ˜
                    function isEmptyRow(row) {
                        return !row || row.every(cell => !cell || cell.toString().trim() === '');
                    }
                    
                    // í—¤ë” í–‰ë“¤ ì°¾ê¸°
                    const headerIndices = [];
                    for (let i = 0; i < data.length; i++) {
                        if (isHeaderRow(data[i])) {
                            headerIndices.push(i);
                            console.log(`í—¤ë” í–‰ ë°œê²¬: ${i}ë²ˆì§¸ í–‰`, data[i]);
                        }
                    }
                    
                    console.log('ë°œê²¬ëœ í—¤ë” í–‰ ì¸ë±ìŠ¤ë“¤:', headerIndices);
                    
                    if (headerIndices.length === 0) {
                        console.log('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ í–‰ì„ í—¤ë”ë¡œ ê°€ì •í•©ë‹ˆë‹¤.');
                        allData['Sheet1'] = data;
                    } else if (headerIndices.length === 1) {
                        // ë‹¨ì¼ ì‹œíŠ¸
                        console.log('ë‹¨ì¼ ì‹œíŠ¸ë¡œ ì²˜ë¦¬');
                        allData['Sheet1'] = data;
                    } else {
                        // ë‹¤ì¤‘ ì‹œíŠ¸ ì²˜ë¦¬
                        console.log('ë‹¤ì¤‘ ì‹œíŠ¸ë¡œ ì²˜ë¦¬');
                        
                        for (let i = 0; i < headerIndices.length; i++) {
                            const startIndex = headerIndices[i];
                            let endIndex;
                            
                            if (i < headerIndices.length - 1) {
                                // ë‹¤ìŒ í—¤ë” ì§ì „ê¹Œì§€
                                endIndex = headerIndices[i + 1];
                            } else {
                                // ë§ˆì§€ë§‰ ì‹œíŠ¸ëŠ” íŒŒì¼ ëê¹Œì§€
                                endIndex = data.length;
                            }
                            
                            // ì‹œíŠ¸ ë°ì´í„° ì¶”ì¶œ
                            let sheetData = data.slice(startIndex, endIndex);
                            
                            // ëì—ì„œ ë¹ˆ í–‰ë“¤ ì œê±°
                            while (sheetData.length > 1 && isEmptyRow(sheetData[sheetData.length - 1])) {
                                sheetData.pop();
                            }
                            
                            if (sheetData.length > 1) { // í—¤ë” + ìµœì†Œ 1ê°œ ë°ì´í„° í–‰
                                const sheetName = `Sheet${i + 1}`;
                                allData[sheetName] = sheetData;
                                console.log(`${sheetName} ìƒì„±: ${sheetData.length}í–‰`);
                            }
                        }
                    }
                    
                    // ëŒ€ì•ˆ: ë¹ˆ í–‰ìœ¼ë¡œ êµ¬ë¶„í•˜ëŠ” ë°©ì‹ë„ ì‹œë„
                    if (Object.keys(allData).length <= 1 && headerIndices.length === 0) {
                        console.log('í—¤ë” ê¸°ë°˜ ë¶„í•  ì‹¤íŒ¨. ë¹ˆ í–‰ ê¸°ë°˜ìœ¼ë¡œ ì¬ì‹œë„');
                        allData = {};
                        
                        let currentSheet = [];
                        let sheetIndex = 1;
                        let hasFoundValidSheet = false;
                        
                        for (let i = 0; i < data.length; i++) {
                            const row = data[i];
                            
                            if (isEmptyRow(row)) {
                                if (currentSheet.length > 0) {
                                    // í˜„ì¬ ì‹œíŠ¸ì— í—¤ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
                                    const hasHeader = currentSheet.some(r => isHeaderRow(r));
                                    if (hasHeader || currentSheet.length > 3) { // í—¤ë”ê°€ ìˆê±°ë‚˜ ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìˆìœ¼ë©´
                                        const sheetName = `Sheet${sheetIndex}`;
                                        allData[sheetName] = [...currentSheet];
                                        console.log(`ë¹ˆ í–‰ ê¸°ë°˜ ${sheetName} ìƒì„±: ${currentSheet.length}í–‰`);
                                        hasFoundValidSheet = true;
                                        sheetIndex++;
                                    }
                                    currentSheet = [];
                                }
                            } else {
                                currentSheet.push(row);
                            }
                        }
                        
                        // ë§ˆì§€ë§‰ ì‹œíŠ¸ ì¶”ê°€
                        if (currentSheet.length > 0) {
                            const hasHeader = currentSheet.some(r => isHeaderRow(r));
                            if (hasHeader || currentSheet.length > 3) {
                                const sheetName = `Sheet${sheetIndex}`;
                                allData[sheetName] = [...currentSheet];
                                console.log(`ë¹ˆ í–‰ ê¸°ë°˜ ë§ˆì§€ë§‰ ${sheetName} ìƒì„±: ${currentSheet.length}í–‰`);
                                hasFoundValidSheet = true;
                            }
                        }
                        
                        // ê·¸ë˜ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ì‹œíŠ¸ë¡œ
                        if (!hasFoundValidSheet) {
                            console.log('ëª¨ë“  ë¶„í•  ë°©ì‹ ì‹¤íŒ¨. ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ì‹œíŠ¸ë¡œ ì²˜ë¦¬');
                            allData['Sheet1'] = data;
                        }
                    }

                    console.log('ì²˜ë¦¬ëœ ì‹œíŠ¸ ìˆ˜:', Object.keys(allData).length);
                    console.log('ì‹œíŠ¸ ì´ë¦„ë“¤:', Object.keys(allData));

                    // ì‹œíŠ¸ ì»¨íŠ¸ë¡¤ ìƒì„±
                    createSheetControls();
                    
                    // ëª¨ë“  ì‹œíŠ¸ ë°ì´í„° í‘œì‹œ
                    Object.keys(allData).forEach((sheetName, index) => {
                        const color = colors[index % colors.length];
                        console.log(`ì‹œíŠ¸ ${sheetName} ì²˜ë¦¬ ì‹œì‘, ìƒ‰ìƒ: ${color}`);
                        processAndDisplayData(sheetName, allData[sheetName], color);
                    });

                    document.getElementById('status').textContent = 
                        `${Object.keys(allData).length}ê°œ ì‹œíŠ¸ ë¡œë“œ ì™„ë£Œ`;
                },
                error: function(error) {
                    console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                    document.getElementById('status').textContent = 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
            });
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            document.getElementById('csvFile').addEventListener('change', handleFileSelect);
            document.getElementById('showArrows').addEventListener('change', toggleArrows);
            
            // ì§€ë„ í´ë¦­ ì‹œ íŒì—… ì œê±°
            map.on('click', clearPopup);
        });
    </script>
</body>
</html>